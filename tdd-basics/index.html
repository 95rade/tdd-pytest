<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TDD Basics - TDD with pytest</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "TDD Basics";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> TDD with pytest</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">About</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">TDD Basics</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#tdd-basics">TDD Basics</a></li>
                
                    <li><a class="toctree-l4" href="#project-setup">Project setup</a></li>
                
                    <li><a class="toctree-l4" href="#starting-the-actual-app">Starting the actual app</a></li>
                
                    <li><a class="toctree-l4" href="#unit-tests-vs-functional-tests">Unit tests vs functional tests</a></li>
                
                    <li><a class="toctree-l4" href="#testing-user-interactions">Testing user interactions</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tdd-advanced/">TDD Advanced</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">TDD with pytest</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>TDD Basics</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/vanzaj/tdd-pytest" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="tdd-basics">TDD Basics<a class="headerlink" href="#tdd-basics" title="Permanent link">&para;</a></h1>
<p>Here we will build a simple todo app following roughly the same steps as in the
Part I of <a href="http://chimera.labs.oreilly.com/books/1234000000754">TDD with Python</a> book.</p>
<h2 id="project-setup">Project setup<a class="headerlink" href="#project-setup" title="Permanent link">&para;</a></h2>
<p>Fist of all we need to create the project&rsquo;s directory structure and install
minimal requirements into a &ldquo;virtualenv&rdquo;. Then we write the first test which
should obviously &ldquo;fail&rdquo; since there is no actual application code written at
this point. And then we write a minimal Flask app, just to get the test to pass.</p>
<pre><code class="bash">$ cd ~/Projects
$ mkdir tdd-todoapp
$ cd tdd-todoapp
$ pyvenv venv
$ . venv/bin/activate
$ python -V
Python 3.5.0

$ pip install Flask
$ pip install pytest pytest-splinter
</code></pre>

<p>Create the <code>app</code> and <code>tests</code> dirs:</p>
<pre><code class="bash">$ mkdir todoapp &amp;&amp; mkdir tests
$ touch tests/functional_tests.py
</code></pre>

<pre><code class="python"># tests/functional_tests.py
from splinter import Browser

BASE_URL = 'http://localhost:5000'

with Browser() as browser:
    browser.visit(BASE_URL)
    assert browser.is_text_present('hello world')
</code></pre>

<p>Run the test. You should see an <code>AssertionError</code>.</p>
<pre><code>$ python tests/functional_test.py
Traceback (most recent call last):
  File &quot;tests/functional_test.py&quot;, line 8, in &lt;module&gt;
      assert browser.is_text_present('hello world')
      AssertionError
</code></pre>

<p>Note that we haven&rsquo;t actually used <code>pytest</code> yet. <code>functional_test.py</code> is just
a regular python script<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. Now, create a basic flask app:</p>
<pre><code class="python"># todoapp/__init__.py
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    return 'hello world'

if __name__ == &quot;__main__&quot;:
    app.run()
</code></pre>

<p>Open another terminal, activate <code>venv</code>, and run the app:</p>
<pre><code class="bash">$ python todoapp/__init__.py
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
</code></pre>

<p>Rerun the test and see it pass.</p>
<p>At this point you should have the following files in your project dir:</p>
<pre><code>├── tests
│   └── functional_test.py
├── todoapp
│   └── __init__.py
└── venv
    ├── bin
    ├── include
    ...
</code></pre>

<h2 id="starting-the-actual-app">Starting the actual app<a class="headerlink" href="#starting-the-actual-app" title="Permanent link">&para;</a></h2>
<p>We can use <code>functional_test.py</code> to guide the development of the todo app.  This
can be as simple as using comments to write a walk-through the app&rsquo;s features by
an imaginary user. This is a variation on
&ldquo;<a href="http://tom.preston-werner.com/2010/08/23/readme-driven-development.html">Readme driven development</a>&rdquo; theme.</p>
<pre><code class="python"># tests/functional_test.py
from splinter import Browser

BASE_URL = 'http://localhost:5000'

with Browser() as browser:
    browser.visit(BASE_URL)
    assert browser.is_text_present('hello world')


# Edith has heard about a cool new online to-do app.
# She goes to check out its homepage

# She notices the page title and header mention to-do lists

# She is invited to enter a to-do item straight away

# She types &quot;Buy peacock feathers&quot; into a text box (Edith's hobby
# is tying fly-fishing lures)

# When she hits enter, the page updates, and now the page lists
# &quot;1: Buy peacock feathers&quot; as an item in a to-do list

# There is still a text box inviting her to add another item. She
# enters &quot;Use peacock feathers to make a fly&quot; (Edith is very methodical)

# The page updates again, and now shows both items on her list

# Edith wonders whether the site will remember her list. Then she sees
# that the site has generated a unique URL for her -- there is some
# explanatory text to that effect.

# She visits that URL - her to-do list is still there.

# Satisfied, she goes back to sleep
</code></pre>

<p><code>Unittest</code> is the standard Python module for creating and running tests.
<code>Pytest</code> is an alternative testing framework. It requires less boilerplate code
and is arguably easier to use. We can adapt <code>functional_test.py</code> to test the
&ldquo;check homepage&rdquo; feature as follows:</p>
<pre><code class="python"># tests/functional_test.py
import pytest
from splinter import Browser

@pytest.yield_fixture(scope='session')
def browser():
    b = Browser()
    yield b
    b.quit()

BASE_URL = 'http://localhost:5000'

def _r(route):
    &quot;&quot;&quot; routing helper &quot;&quot;&quot;
    if not route.startswith('/'):
        route = '/' + route
    return '%s%s' % (BASE_URL, route)

# Edith has heard about a cool new online to-do app.
# She goes to check out its homepage
def test_can_check_homepage(browser):
    browser.visit(_r('/'))
    assert browser.is_text_present('hello world')

# She notices the page title and header mention to-do lists
# ...
</code></pre>

<p>Note how the <code>browser</code> instance has been converted into a function decorated
with <code>yield_fixture</code><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. It does the job of both <code>setUp()</code> and <code>tearDown()</code> methods
of a <code>unittest.TestCase</code>. It is possible to organize tests into classes, but it
is not required.</p>
<p>Before running <code>pytest</code>, create a <code>setup.cfg</code> to exclude <code>venv</code> (and other dirs
if needed) from being in the tests auto-discovery path.</p>
<pre><code class="config">[pytest]
norecursedirs = .git venv
</code></pre>

<p>Now run the test (note that <code>pytest</code>&lsquo;s runner is <code>py.test</code>):</p>
<pre><code class="bash">$ py.test -v
=================================== test session starts ====================================
platform darwin -- Python 3.5.0, pytest-2.8.3, py-1.4.31, pluggy-0.3.1 -- /Users/ivan/Projects/tdd-todoapp/venv/bin/python3.5
cachedir: .cache
rootdir: /Users/ivan/Projects/tdd-todoapp, inifile: setup.cfg
plugins: splinter-1.7.0, xdist-1.13.1
collected 1 items

tests/functional_test.py::test_can_check_homepage PASSED

======================= 1 passed, 1 pytest-warnings in 2.34 seconds ========================
</code></pre>

<p>Use <code>py.test -ra</code> if you want to see what is causing <code>pytest-warnings</code>.</p>
<p>Back to the app. &ldquo;hello world&rdquo; is nice, but it has little to do with a todo app.
The test should look more like:</p>
<pre><code class="python"># Edith has heard about a cool new online to-do app.
def test_can_check_homepage(browser):
    # She goes to check out its homepage
    browser.visit(_r('/'))
    # She notices the page title and header mention to-do lists
    assert 'To-Do' in browser.title
</code></pre>

<pre><code class="bash">$ py.test
&lt;... skipped lines ...&gt;
========================================= FAILURES =========================================
_________________________________ test_can_check_homepage __________________________________

browser = &lt;splinter.driver.webdriver.firefox.WebDriver object at 0x106a3d7b8&gt;

    def test_can_check_homepage(browser):
        # She goes to check out its homepage
        browser.visit(_r('/'))
        # She notices the page title and header mention to-do lists
&gt;       assert 'To-Do' in browser.title
E       assert 'To-Do' in ''
&lt;... skipped lines ...&gt;
</code></pre>

<p>Note the last line. It shows the actual value of <code>browser.title</code> during the
test run. Time to update the app:</p>
<pre><code class="bash">$ mkdir todoapp/templates
$ touch todoapp/templates/home.html
</code></pre>

<pre><code class="html">&lt;!-- todoapp/templates/home.html --&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;To-Do&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;h1&gt;My todos list&lt;/h1&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<pre><code class="python"># todoapp/__init__.py
from flask import Flask, render_template

app = Flask(__name__)

@app.route('/')
def home():
    return render_template('home.html')

if __name__ == &quot;__main__&quot;:
    app.run(debug=True)
</code></pre>

<p><code>py.test</code> should now pass.</p>
<h2 id="unit-tests-vs-functional-tests">Unit tests vs functional tests<a class="headerlink" href="#unit-tests-vs-functional-tests" title="Permanent link">&para;</a></h2>
<p>The tests so far are called &ldquo;functional&rdquo; because they test an application from
the user perspective; open a browser, visit a url, etc. These tests work without
any knowledge about the app&rsquo;s implementation details. Almost any kind of web
application, written in Python or another language, can be tested with <code>pytest</code>
and <code>splinter</code>. On the other hand, unit tests (the concept and not the
<code>unittest</code> module) are supposed to test an application from the developer point
of view.  Unit tests should cover very specific parts of code. Normally, there
should be many more unit tests than functional tests.  Because of that unit
tests must be fast. Opening and closing browsers is not very useful on the
context of unit tests. As described in the TDDPy book, the development process
goes as follows:</p>
<ol>
<li>Start by writing a functional test, describing the new functionality from
    the user’s point of view.</li>
<li>Once we have a functional test that fails, we start to think about how to
    write code that can get it to pass (or at least to get past its current
    failure). We now use one or more unit tests to define how we want our code to
    behave—the idea is that each line of production code we write should be tested
    by (at least) one of our unit tests.</li>
<li>Once we have a failing unit test, we write the smallest amount of
    application code we can, just enough to get the unit test to pass. We may
    iterate between steps 2 and 3 a few times, until we think the functional test
    will get a little further.</li>
<li>Now we can rerun our functional tests and see if they pass, or get a little
    further. That may prompt us to write some new unit tests, and some new code,
    and so on.</li>
</ol>
<p>Let&rsquo;s create a unit test for the todo app which does the same thing as
the <code>test_can_check_homepage()</code> inside <code>functional_test.py</code>:</p>
<pre><code class="python"># tests/unit_test.py

import pytest
from todoapp import app

@pytest.fixture(scope='session')
def client():
    app.config['TESTING'] = True
    return app.test_client()

def test_home_page_returns_correct_html(client):
    rsp = client.get('/')
    assert rsp.status == '200 OK'
    assert '&lt;title&gt;To-Do&lt;/title&gt;' in rsp.get_data(as_text=True)
</code></pre>

<p>and run it</p>
<pre><code class="bash">$ py.test tests/unit_test.py
========================================== ERRORS ==========================================
___________________________ ERROR collecting tests/unit_test.py ____________________________
tests/unit_test.py:2: in &lt;module&gt;
    import todoapp
E   ImportError: No module named 'todoapp'
</code></pre>

<p>The app&rsquo;s module is not in the Python&rsquo;s path, so <code>pytest</code> can&rsquo;t import it. The
simplest fix is to set the <code>PYTHONPATH</code> shell variable to the current dir:</p>
<pre><code class="bash">$ export PYTHONPATH='.'

$ py.test -v tests/unit_test.py
=================================== test session starts ====================================

tests/unit_test.py::test_home_page_returns_correct_html PASSED

======================= 1 passed, 1 pytest-warnings in 0.02 seconds
</code></pre>

<p>0.02 seconds is much better compared to 2.5 seconds needed to start a browser.</p>
<p>Since we know that the <code>home</code> view should return <code>home.html</code> template,
we can check the returned html like:</p>
<pre><code class="python">def test_home_page_returns_correct_html(client):
    rsp = client.get('/')
    assert rsp.status == '200 OK'
    tpl = app.jinja_env.get_template('home.html')
    assert tpl.render() == rsp.get_data(as_text=True)
</code></pre>

<p>Your project dir should look like (excluding <code>*.pyc</code> and <code>__pycache__</code> dir):</p>
<pre><code>├── setup.cfg
├── tests
│   ├── functional_test.py
│   └── unit_test.py
├── todoapp
│   ├── __init__.py
│   └── templates
└── venv
    ├── bin
...
</code></pre>

<h2 id="testing-user-interactions">Testing user interactions<a class="headerlink" href="#testing-user-interactions" title="Permanent link">&para;</a></h2>
<p>Time to get back to functional tests. The next step is to add user input
functionality.</p>
<pre><code class="python"># tests/function_test.html

# ...

# Edith has heard about a cool new online to-do app.
def test_can_check_homepage(browser):
    # She goes to check out its homepage
    browser.visit(_r('/'))

    # She notices the page title and header mention to-do lists
    assert 'To-Do' in browser.title
    header = browser.find_by_tag('h1').first
    assert 'todos' in header.text

    # She is invited to enter a to-do item straight away
    inputbox = browser.find_by_id('id_new_item').first
    assert inputbox.tag_name == 'input'
    assert inputbox['placeholder'] == 'Enter a to-do item'

    # ...
</code></pre>

<p>To fix this failing test, we need to fix the <code>home</code> tempalate.</p>
<pre><code class="html">&lt;body&gt;
  &lt;h1&gt;My todos list&lt;/h1&gt;
  &lt;input id=&quot;id_new_item&quot; placeholder=&quot;Enter a to-do item&quot;/&gt;
&lt;/body&gt;
</code></pre>

<p>Next step:</p>
<pre><code class="python"># tests/function_test.py

# ...

    # She types &quot;Buy peacock feathers&quot; into a text box (Edith's hobby
    # is tying fly-fishing lures)
    inputbox.type('Buy peacock feathers')

    # When she hits enter, the page updates, and now the page lists
    # &quot;1: Buy peacock feathers&quot; as an item in a to-do list
    inputbox.type('\n')
    table = browser.find_by_id('id_list_table').first
    rows = table.find_by_tag('tr')
    assert any(row.text == '1: Buy peacock feathers' for row in rows)

# ...
</code></pre>

<pre><code class="html">&lt;body&gt;
  &lt;h1&gt;My todos list&lt;/h1&gt;
  &lt;input id=&quot;id_new_item&quot; placeholder=&quot;Enter a to-do item&quot;/&gt;
  &lt;table id=&quot;id_list_table&quot;&gt;
  &lt;/table&gt;
&lt;/body&gt;
</code></pre>

<pre><code class="bash">$ py.test  tests/functional_test.py

======================================== FAILURES ========================================
________________________________ test_can_check_homepage _________________________________

&lt;... skipped lines ...&gt;

        rows = table.find_by_tag('tr')
&gt;       assert any(row.text == '1: Buy peacock feathers' for row in rows)
E       assert any(&lt;generator object test_can_check_homepage.&lt;locals&gt;.&lt;genexpr&gt; at 0x10738c780&gt;)

tests/functional_test.py:45: AssertionError
</code></pre>

<p>If you want a more explicit error message, change the assertion line like this:</p>
<pre><code class="python">
    assert any(row.text == '1: Buy peacock feathers' for row in rows), \
           'New to-do item did not appear in the table'

</code></pre>

<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Non-trivial apps will have many tests organized in multiple functions or
classes. That&rsquo;s when we need to use a &ldquo;test runner&rdquo; &ndash; a command that discovers
and runs all the tests, and then reports which ones have passed or failed.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Pytest fixtures must be callable objects passed to test functions as
arguments. Inside a test function we get an instance of the return or yield
object.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tdd-advanced/" class="btn btn-neutral float-right" title="TDD Advanced"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="About"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tdd-advanced/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
